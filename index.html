<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        body,html{padding: 0; margin: 0;}
    </style>
    <script src="js/jquery-3.1.1.min.js"></script>
    <script src="js/jcanvas.min.js"></script>
    <script src="js/canvas2image.js"></script>
    <script>
        /*
        * Image Comment Web Tool
        * Author : Carl
        *
        * */

        function ImageComment(options){
            this.default={
                canvasWrapper:"canvasWrapper",
                loadImageBtn:"#libtn",
                circleBtn:"#ucbtn",
                rectBtn:"#urbtn",
                textBtn:"#utbtn",
                clearCanvasBtn:"#ccbtn",
                exportBtn:"#eibtn"
            };
            this.options=$.extend({},this.default,options);

            this.mainCanvas=null;
            this.selectedLayer=null;
        };

        ImageComment.prototype={
            exportImage:function(){
                Canvas2Image.saveAsJPEG($(this.mainCanvas)[0],100,100);
            },
            clearCanvas:function() {
                if(this.selectedLayer){
                    $(this.mainCanvas).removeLayer(this.selectedLayer).drawLayers();
                }else{
                    $(this.mainCanvas).removeLayers().drawLayers();
                }
                this.selectedLayer=null;
            },
            switchActive:function(name){
                var _this=this;
                $(this.mainCanvas).getLayers(function(layer) {
                    var option={};
                    var _colorAttr="";

                    if(layer.type=="text"){
                        _colorAttr="fillStyle";
                    }else{
                        _colorAttr="strokeStyle";
                    }
                    
                    if(layer.name==name){
                        option[_colorAttr]="#9e9e9e";
                        $(_this.mainCanvas).setLayer(layer.name, option).drawLayers();
                    }else{
                        option[_colorAttr]="#da0000";
                        $(_this.mainCanvas).setLayer(layer.name, option).drawLayers();
                    }
                });
            },
            loadImage:function(e){
                var _this=this;
                this.clearCanvas();
                var a = new Image();
                a.src=e.value.replace("C:\\fakepath\\","image/");
                a.onload=function(){
                    if(_this.mainCanvas){
                        _this.mainCanvas.remove();
                    }
                    _this.mainCanvas = document.createElement("canvas");
                    _this.mainCanvas.setAttribute("width", this.width);
                    _this.mainCanvas.setAttribute("height", this.height);
                    document.getElementById(_this.options.canvasWrapper).appendChild(_this.mainCanvas);

                    $(_this.mainCanvas).drawImage({
                        layer:true,
                        fromCenter: false,
                        source: e.value.replace("C:\\fakepath\\","image/"),
                        x: 0, y: 0
                    });
                }
            },
            useRectangle:function(){
                var _this=this;
                $(this.mainCanvas).on("mousedown",function(ev){
                    var _downX=ev.offsetX+4;
                    var _downY=ev.offsetY+4;
                    var _name=new Date().getTime()+"_rect";

                    $(this).addLayer({
                        name:_name,
                        type: 'rectangle',
                        strokeStyle: '#da0000',
                        strokeWidth: 4,
                        x: _downX, y: _downY,
                        width: 0, height: 0,
                        click:function(layer){
                            _this.selectedLayer=layer.name;
                            _this.switchActive(layer.name);
                        }
                    });

                    $(this).on("mousemove",function(ev){
                        _this._move(ev,_downX,_downY,_name);
                    })
                })

                $(_this.mainCanvas).on("mouseup",function(ev){
                    $(this).off("mousedown mousemove");
                    _this.selectedLayer=null;
                })
            },
            useCircle:function(){
                var _this=this;
                $(this.mainCanvas).on("mousedown",function(ev){
                    var _downX=ev.offsetX+4;
                    var _downY=ev.offsetY+4;
                    var _name=new Date().getTime()+"_circle";

                    $(this).addLayer({
                        name:_name,
                        type: 'ellipse',
                        strokeStyle: '#da0000',
                        strokeWidth: 4,
                        x: _downX, y: _downY,
                        width: 0, height: 0,
                        click:function(layer){
                            _this.selectedLayer=layer.name;
                            _this.switchActive(layer.name);
                        }
                    });

                    $(this).on("mousemove",function(ev){
                        _this._move(ev,_downX,_downY,_name);
                    })
                })

                $(_this.mainCanvas).on("mouseup",function(ev){
                    $(this).off("mousedown mousemove");
                    _this.selectedLayer=null;
                })
            },
            useText:function(){
                var _this=this;
                var _tempRect,_finalPosition;

                $(this.mainCanvas).on("mousedown",function(ev){
                    var _downX=ev.offsetX+2;
                    var _downY=ev.offsetY+2;
                    var _name=_tempRect=new Date().getTime()+"_tempRect";

                    $(this).addLayer({
                        name:_name,
                        type: 'rectangle',
                        strokeStyle: '#da0000',
                        strokeWidth: 2,
                        x: _downX, y: _downY,
                        width: 0, height: 0
                    });

                    $(this).on("mousemove",function(ev){
                        _finalPosition=_this._move(ev,_downX,_downY,_name);
                    })
                })

                $(_this.mainCanvas).on("mouseup",function(ev){
                    $(this).off("mousedown mousemove mouseup");
                    $(this).removeLayer(_tempRect);

                    $(this).addLayer({
                        name:_tempRect=new Date().getTime()+"_text",
                        type: 'text',
                        fillStyle: '#36c',
                        fontSize: '12px',
                        fontFamily: 'Trebuchet MS, sans-serif',
                        text: 'The quick brown fox jumps over the lazy dog.',
                        draggable: true,
                        x: _finalPosition.x,
                        y: _finalPosition.y,
                        align: 'left',
                        maxWidth:_finalPosition.width,
                        click:function(layer){
                            _this.selectedLayer=layer.name;
                            _this.switchActive(layer.name);
                        }
//                        ,height:_finalPosition.height
                    }).drawLayers();

                    _this.selectedLayer=null;
                })
            },
//            _move:function(event,x,y,_name){
//                var currentWidth=event.offsetX-x;
//                var currentHeight=event.offsetY-y;
//
//                var currentX=x+currentWidth/2;
//                var currentY=y+currentHeight/2;
//
//                $(this.mainCanvas).setLayer(_name, {
//                    x:currentX , y: currentY,
//                    width: currentWidth, height: currentHeight
//                }).drawLayers();
//            },
            _move:function(event,x,y,_name){
                var currentWidth=event.offsetX-x-3;
                var currentHeight=event.offsetY-y-3;

                var currentX=x+currentWidth/2;
                var currentY=y+currentHeight/2;

                $(this.mainCanvas).setLayer(_name, {
                    x:currentX , y: currentY,
                    width: currentWidth, height: currentHeight
                }).drawLayers();

                return {x:currentX , y: currentY,width: currentWidth, height: currentHeight};
            },
            _init:function(){
                var _this=this;
                $(this.options.loadImageBtn).on("change",function(event){
                    _this.loadImage(event.currentTarget);
                });
                $(this.options.circleBtn).on("click",function(){
                    _this.useCircle()
                });
                $(this.options.rectBtn).on("click",function(){
                    _this.useRectangle()
                });
                $(this.options.textBtn).on("click",function(){
                    _this.useText()
                });

                $(this.options.clearCanvasBtn).on("click",function(){
                    _this.clearCanvas()
                });
                $(this.options.exportBtn).on("click",function(){
                    _this.exportImage()
                });
            }
        };

        $(document).ready(function(){
            var im=new ImageComment();
            im._init();
        })

    </script>
</head>
<body>
<div style="text-align: center;margin: 15px 0;">
    <input id="libtn" type="file" value="Load Image" />
    <input id="urbtn" type="button" value="Add Rectangle Mark" />
    <input id="ucbtn" type="button"  value="Add Circle Mark" />
    <input id="utbtn" type="button"  value="Add Text" />
    <input id="ccbtn" type="button"  value="Remove Selected Mark" />
    <input id="eibtn" type="button"  value="Export" />
</div>
<div id="canvasWrapper"></div>
</body>
</html>